# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# ref: https://atlas.hashicorp.com/boxes/search
#VMBOX = "fgrehm/precise64-lxc"
#VMBOX = "fgrehm/trusty64-lxc"
#VMBOX = "centos6"           # "fgrehm/centos-6-64-lxc" hangs, use docker...
#VMBOX = "frensjan/centos-7-64-lxc"
VMBOX = "ubuntu/trusty64"
MYUSER = "ppearl"           # used to map my home into the VM
HOSTNAME = "zcsdev"         # name of VM
SRCDIR = "/site"            # map my source directory into the VM
HOMEDIR = "/home/" + MYUSER

# provisioning script and args # -b == build, -d == dev, -r == runtime
# PPATH = "/vagrant/vsetup.sh"
# PARGS = ["-b"]
PPATH =
  "https://raw.githubusercontent.com/plobbes/vagrant-provision-zimbra/master/vsetup.sh"
PARGS = ["-d"]

VAGRANTFILE_API_VERSION = "2"
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  if VMBOX == "centos6"
    config.vm.provider :docker do |docker|
      docker.build_dir = VMBOX
      docker.has_ssh = true
      docker.name = HOSTNAME
    end
  else
    config.vm.box = VMBOX
  end
  config.vm.host_name = HOSTNAME
  config.vm.synced_folder HOMEDIR, HOMEDIR
  #config.vm.synced_folder "/site", "/site"

  # virtualbox: mmap broken on mapped filesystems
  # - ref: https://www.virtualbox.org/ticket/819
  config.vm.synced_folder SRCDIR, SRCDIR #, type: "nfs"
  # map vagrant user/grp to me, not root
  config.nfs.map_uid = Process.uid
  config.nfs.map_gid = Process.gid

  config.vm.provider :lxc do |lxc|
    lxc.customize "cgroup.memory.limit_in_bytes", "2048M"
  end
  config.vm.provider :virtualbox do |vb|
    vb.memory = "2048"
  end

  # http://fgrehm.viewdocs.io/vagrant-cachier
  if config.vm.box.nil? && Vagrant.has_plugin?("vagrant-cachier")
    config.cache.scope = :box
  end

  # refs: nfs[1] with private_network[2] and dhcp conflicting host adapter[3]
  # 1. http://docs.vagrantup.com/v2/synced-folders/nfs.html
  # 2. http://docs.vagrantup.com/v2/networking/private_network.html
  # 3. https://github.com/mitchellh/vagrant/issues/3083 workaround:
  #    VBoxManage dhcpserver remove --netname HostInterfaceNetworking-vboxnet0
  # config.vm.network "private_network", type: "dhcp"
  # config.vm.provision "shell", inline: PPATH + " " + PARGS * " " + "; /vagrant/vsetup.custom.sh " + MYUSER
  config.vm.provision "shell", path: PPATH, args: PARGS
end
